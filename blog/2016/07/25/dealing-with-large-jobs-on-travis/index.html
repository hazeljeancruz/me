<!doctype html> <html lang=en> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=author content="Wojciech Adam Koszek"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta name="p:domain_verify" content=35dedfd4f697e6e974b0ae6631ca7351 /> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script> <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="/css/1406-fonts.css"> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="/css/debug.css"> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="/css/code.css"> <script src="https://code.jquery.com/jquery-git.min.js"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-8027537-3', 'auto');
  ga('send', 'pageview');
</script> <script>
	(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
	(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
	e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
	})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
	_st('install','_i_CdLX9xwxixHZtjxHu','2.0.0');
</script> <link rel=icon type="image/png" href="/img/favicon.ico"> <title>Dealing with large jobs on Travis-CI</title> <meta name=description content="Below I explain problems you may run into when your continuous integration build starts to take a long time and I show some simple solutions for deadling with them. "/> <meta property="og:title" content="Dealing with large jobs on Travis-CI"/> <meta property="og:description" content="Below I explain problems you may run into when your continuous integration build starts to take a long time and I show some simple solutions for deadling with them. "/> <meta name="twitter:card" content=summary_large_image> <meta name="twitter:site" content="@wkoszek"/> <meta name="twitter:creator" content="@wkoszek"/> <meta name="twitter:title" content="Dealing with large jobs on Travis-CI"/> <meta name="twitter:description" content="Below I explain problems you may run into when your continuous integration build starts to take a long time and I show some simple solutions for deadling with them. "/> <meta property="og:type" content=article /> <meta property="article:author" content="https://www.koszek.com/about"/> <meta property="article:publisher" content="https://www.koszek.com/"/> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> </head> <body> <div class=container> <div class="row noprint"> <div class="col-md-3 logo"> <a href="/">Wojciech Adam Koszek</a> </div> <div class="col-md-9 links hidden-sm hidden-xs"> <a class=in id=blog href="/">Blog</a> <a class=in id=reading href="/reading/">Reading</a> <a class=in id=papers href="/papers/">Papers</a> <a class=in id=about href="/about/">About me</a> <input class=st-default-search-input> </div> </div> <div class="row noprint"> <hr/> </div> <div class="row hidden-md hidden-lg links noprint"> <div class=col-xs-4> <br> <a class=in href="/">Blog</a> </div> <div class=col-xs-4> <br> <a class=in href="/reading/">Reading</a> </div> <div class=col-xs-4> <br> </div> </div> <div class="row hidden-md hidden-lg links noprint"> <div class=col-xs-4> <br> <a class=in href="/papers/">Papers</a> </div> <div class=col-xs-4> <br> <a class=in href="/about/">About</a> </div> <div class=col-xs-4> <br> <a class="hidden-lg hidden-md" href="#notes">Notes</a> </div> </div> <div class="row hidden-md hidden-lg links text-center noprint"> <br> <input class=st-default-search-input> </div> <div class=row> <div class="col-md-2 leftpanel hidden-xs hidden-sm"> </div> <div class="col-md-7 content"> <article> <h1 class=title>Dealing with large jobs on Travis-CI</h1> <i>by Wojciech Adam Koszek</i> &nbsp;&nbsp;&sdot;&nbsp;&nbsp; <i>Jul 25, 2016</i> &nbsp;&nbsp;&sdot;&nbsp;&nbsp; <i>Menlo Park, CA</i> <br/> <br/> <b>Below I explain problems you may run into when your continuous integration build starts to take a long time and I show some simple solutions for deadling with them. </b> <br/> <hr class=noprint /> <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f9a67fb0188b069" async=async></script> <div class=addthis_sharing_toolbox></div> <hr class=noprint /> <div class=article_body> <p>I’m releasing <a href="https://github.com/wkoszek/">all my projects</a> <a href="http://www.koszek.com/blog/2016/07/11/what-i-learned-from-connecting-60-projects-to-ci-system/">through continuous integration</a>, so I end up working with <a href="http://www.travis-ci.org">Travis-CI</a> a lot. Travis provides a corresponding diagnostic page for each project I have linked to it from GitHub. For example one of my GitHub projects <a href="https://github.com/wkoszek/cpu60">is here</a> and its Travis-CI subpage <a href="https://travis-ci.org/wkoszek/kmnsim">would be here</a>. If you look at the link format, you’ll understand what I mean. In there you can see what the output of your job was. Most of the jobs are fairly simple and finish within short period of time. For these jobs debugging the build steps is easy: just look at the console output and see what’s wrong. It’s what I do 95% of time. Below I give hints on how to handle 5% of other cases.</p> <h1 id=bigger-projects>Bigger projects</h1> <p>While working on <a href="http://www.sensorama.org">Sensorama for iOS</a> I had to do something different, since it generates a lot of output from many tools. It has many dependencies on <a href="https://rubygems.org">Ruby Gems</a> and <a href="https://cocoapods.org/">CocoaPods</a>, which make it long-running as well. Unless you’re careful, you’ll make your life and Travis job debugging harder. For me debugging OSX/iOS projects is especially challenging, since it’s a flow of: bug, commit, verify cycles (for Linux/UNIX projects you can run Travis-CI environment in a Docker container).</p> <h1 id=travis-ci-limits-for-open-source-projects>Travis-CI limits for Open Source projects</h1> <p>Travis-CI is entirely free for Open Source, which I find great. Even though its run-time limits are pretty generous, they do exist:</p> <ul> <li>time limit on jobs: which currently is set to 30 minutes.</li> <li>10 minute watchdog: if your job doesn’t output anything in this period, it will be killed.</li> <li>size of the output files is limited to 4MB. If you run over it, your job will be killed.</li> </ul> <p>How does the issue look like?</p> <p>Example (<a href="https://travis-ci.org/wkoszek/sensorama-ios/builds/145737758">from here</a>):</p> <pre class="highlight plaintext"><code>+scan --workspace Sensorama.xcworkspace --scheme SensoramaTests
[08:12:08]: xcrun xcodebuild -list -workspace Sensorama.xcworkspace
No output has been received in the last 10m0s, this potentially indicates a
stalled build or something wrong with the build itself.
The build has been terminated
</code></pre> <p>Another one (<a href="https://travis-ci.org/wkoszek/sensorama-ios/builds/146298516">from here</a>):</p> <pre class="highlight plaintext"><code>/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator9.3.sdk -fasm-bloc
The log length has exceeded the limit of 4 MB (this usually means that the test suite is raising the same exception over and over).
The job has been terminated
</code></pre> <p>How to deal with this stuff?</p> <h1 id=prettifiers>Prettifiers?</h1> <p>For XCode projects just pipe everything what comes from <code>xcodebuild</code> through <code>xcpretty</code>. If you’re using <a href="https://github.com/fastlane/fastlane">fastlane</a> (and if not, you should), then the <code>xcpretty</code> is used automatically. Normally I don’t like the tools which obfuscate real command’s output, but in this case I had no choice. Also <code>xcpretty</code> makes the output understandable.</p> <h1 id=output-folding>Output folding</h1> <p>Travis-CI has this cool undocumented feature called “output folding”. You can group lines of output which belong to the same group of commands. You’ll get them folded together and you don’t have to scroll through all the output thanks to it.</p> <p>How to do it?</p> <p>First of all, your config file <code>.travis.yml</code> for the <code>script</code> entry has to call 1 script. So for Sensorama I have:</p> <pre class="highlight plaintext"><code>language: objective-c
osx_image: xcode7.3
cache: cocoapods
rvm:
- 2.2
podfile: Sensorama/Podfile
script:
- ./scripts/travis_script.sh
#- ./scripts/script_with_folds
addons:
  ssh_known_hosts:
  - gitlab.com
</code></pre> <p>If you want to give it a try, use <code>script_with_folds</code>, borrowed from here.</p> <p>Then it’s pretty easy:</p> <pre class="highlight shell"><code><span class="c">#!/bin/bash</span>

travis_fold<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">action</span><span class="o">=</span><span class="nv">$1</span>
  <span class="nb">local </span><span class="nv">name</span><span class="o">=</span><span class="nv">$2</span>
  <span class="nb">echo</span> -en <span class="s2">"travis_fold:</span><span class="k">${</span><span class="nv">action</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">name</span><span class="k">}</span><span class="se">\r</span><span class="s2">"</span>
<span class="o">}</span>

travis_fold start foo

<span class="nb">echo</span> <span class="s2">"This line appears in the fold's 'header'"</span>

<span class="nb">echo</span> <span class="s2">"Stuff inside"</span>

sleep 2

<span class="nb">echo</span> <span class="s2">"More stuff"</span>

travis_fold end foo
</code></pre> <p>So every fold has to start with <code>travis_fold:ACTION:name</code>, where <code>ACTION</code> is either <code>start</code> or <code>end</code>, and the <code>name</code> is whatever you want.</p> <h1 id=doing-folds-easily>Doing folds easily</h1> <p>For Sensorama I plan to use output folding a lot, so I’ve devised a simpler way to deal with this stuff:</p> <pre class="highlight plaintext"><code>TMP=/tmp/.travis_fold_name

# This is meant to be run from top-level dir. of sensorama-ios

travis_fold() {
  local action=$1
  local name=$2
  echo -en "travis_fold:${action}:${name}\r"
}

travis_fold_start() {
  travis_fold start $1
  echo $1
  /bin/echo -n $1 &gt; $TMP
}

travis_fold_end() {
  travis_fold end `cat ${TMP}`
}
</code></pre> <p>This is a more elaborate version of what I showed before, but it lets you to do:</p> <pre class="highlight plaintext"><code>(
  travis_fold_start BOOSTRAPPING
  ./build.sh bootstrap
  travis_fold_end
)
</code></pre> <p>Without worrying whether the start and end tags for the fold are matched. One of the stupid mistakes I’ve made in one of the commits is that <code>action</code> and <code>name</code> mismatched, and then folding is broken.</p> <h1 id=summary>Summary</h1> <p>For optimizing output logging I’d start from trying to limit job output. In cases where you can’t do it, try to use some output “compressors” and prettyfiers. Remember that these things add complexity and can sometimes make debugging harder, as they essentially obfuscate the output of original commands. At the end use output folding on Travis-CI.</p> <p>Was this article useful? <a href="http://www.twitter.com/wkoszek">Let me know</a></p> </div> </article> <div class="row noprint"> <br> <div class="col-md-6 text-left"> </div> <div class="col-md-6 text-right"> </div> </div> <div class=noprint> <hr> <h3 id=mailing-list>Subscribe for updates</h3> <p> Once a month I send updates on the new content and hints for software engineers. <div id=mc_embed_signup class=row> <form action="//koszek.us3.list-manage.com/subscribe/post?u=0cfe70aa4cdf848b2adbd70c6&amp;id=bc454f0778" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll class=col-md-12> <input type=email value="" name=EMAIL class="required email" id=mce-EMAIL placeholder="Enter E-mail here"> <div id=mce-responses class=clear> <div class=response id=mce-error-response style="display:none"></div> <div class=response id=mce-success-response style="display:none"></div> </div> <div style="position: absolute; left: -5000px;"><input name=b_0cfe70aa4cdf848b2adbd70c6_bc454f0778 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button width="100%"></div> </div> </form> </div> </p> <hr> <b>Liked it? Share it!</b> <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f9a67fb0188b069" async=async></script> <div class=addthis_sharing_toolbox></div> <hr> <p><br/> <strong>About the author:</strong> I’m Wojciech Adam Koszek. I like software, business and design. Poland native. In Bay Area since 2010.   <a href="/about/">More about me…</a></p> <hr> <div id=disqus_thread></div> <script>

var disqus_config = function () {
this.page.url = document.location.href.split('?')[0].split('#')[0];
this.page.identifier = this.page.url;
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//koszek.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </div> <div class=col-md-1> </div> <div class="col-md-2 rightpanel noprint"> <br><h4>Mailing list</h4> <a href="#mailing-list">Subscribe</a> <br><h4>RSS feed</h4> <a href="http://www.koszek.com/feed.xml">RSS</a> <h4>Contact</h4> <a href="mailto:wojciech@koszek.com">E-mail</a><br> <a href="https://twitter.com/wkoszek/">Twitter</a><br> <a href="https://www.linkedin.com/in/wkoszek/">LinkedIn</a><br> <a href="https://github.com/wkoszek/">Github</a><br> <h4>Tags</h4> <span class=tag> <a href="/blog/tags/software-engineering">software engineering</a> </span> <br> <span class=tag> <a href="/blog/tags/tools">tools</a> </span> <br> <span class=tag> <a href="/blog/tags/entrepreneurship">entrepreneurship</a> </span> <br> <span class=tag> <a href="/blog/tags/productivity">productivity</a> </span> <br> </div> </div> <div class="row noprint"> <div class="col-md-12 footer"> <i>&copy;&nbsp;2012&dash;2017 Wojciech Adam Koszek (<a href="https://www.twitter.com/wkoszek/">@wkoszek</a>)</i> <br> Visits so far: <script>
var sc_project=10468040; 
var sc_invisible=0; 
var sc_security="b542d462"; 
var sc_text=2; 
var scJsHost = (("https:" == document.location.protocol) ?  "https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" + scJsHost+ "statcounter.com/counter/counter.js'></"+"script>");
</script> <noscript> <div class=statcounter> <a title="free web stats" href="https://statcounter.com/free-web-stats/" target=_blank> <img class=statcounter src="https://c.statcounter.com/10468040/0/b542d462/0/" alt="free web stats"/></a> </div> </noscript> </div> </div> </div> <script>
        var active_page_elem = document.getElementById('active_page_name')
        var active_page_name = (active_page_elem != null ? active_page_elem.textContent : "blog");
        var active_page_link = document.getElementById(active_page_name);
        active_page_link.className = "ac";
    </script> </body> </html>