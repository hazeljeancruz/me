<!doctype html> <html lang=en> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=author content="Wojciech Adam Koszek"> <meta name=viewport content="width=device-width, initial-scale=1"> <meta name="p:domain_verify" content=35dedfd4f697e6e974b0ae6631ca7351 /> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script> <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]--> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="/css/1406-fonts.css"> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="/css/debug.css"> <link rel=stylesheet media=none onload="if(media!='all')media='all'" href="/css/code.css"> <script src="https://code.jquery.com/jquery-git.min.js"></script> <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-8027537-3', 'auto');
  ga('send', 'pageview');
</script> <script>
	(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
	(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
	e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
	})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
	_st('install','_i_CdLX9xwxixHZtjxHu','2.0.0');
</script> <link rel=icon type="image/png" href="/img/favicon.ico"> <title>Top 3 bugs I make in shell scripts</title> <meta name=description content="Things to shy away from when working on shell scripting. "/> <meta property="og:title" content="Top 3 bugs I make in shell scripts"/> <meta property="og:description" content="Things to shy away from when working on shell scripting. "/> <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/6/60/Shellshock_or_Bashdoor_Unix_Bash_shell_security_bug.svg/2000px-Shellshock_or_Bashdoor_Unix_Bash_shell_security_bug.svg.png"/> <meta name="twitter:card" content=summary_large_image> <meta name="twitter:site" content="@wkoszek"/> <meta name="twitter:creator" content="@wkoszek"/> <meta name="twitter:title" content="Top 3 bugs I make in shell scripts"/> <meta name="twitter:description" content="Things to shy away from when working on shell scripting. "/> <meta name="twitter:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/6/60/Shellshock_or_Bashdoor_Unix_Bash_shell_security_bug.svg/2000px-Shellshock_or_Bashdoor_Unix_Bash_shell_security_bug.svg.png"/> <meta property="og:type" content=article /> <meta property="article:author" content="https://www.koszek.com/about"/> <meta property="article:publisher" content="https://www.koszek.com/"/> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> </head> <body> <div class=container> <div class="row noprint"> <div class="col-md-3 logo"> <a href="/">Wojciech Adam Koszek</a> </div> <div class="col-md-9 links hidden-sm hidden-xs"> <a class=in id=blog href="/">Blog</a> <a class=in id=reading href="/reading/">Reading</a> <a class=in id=papers href="/papers/">Papers</a> <a class=in id=about href="/about/">About me</a> <input class=st-default-search-input> </div> </div> <div class="row noprint"> <hr/> </div> <div class="row hidden-md hidden-lg links noprint"> <div class=col-xs-4> <br> <a class=in href="/">Blog</a> </div> <div class=col-xs-4> <br> <a class=in href="/reading/">Reading</a> </div> <div class=col-xs-4> <br> </div> </div> <div class="row hidden-md hidden-lg links noprint"> <div class=col-xs-4> <br> <a class=in href="/papers/">Papers</a> </div> <div class=col-xs-4> <br> <a class=in href="/about/">About</a> </div> <div class=col-xs-4> <br> <a class="hidden-lg hidden-md" href="#notes">Notes</a> </div> </div> <div class="row hidden-md hidden-lg links text-center noprint"> <br> <input class=st-default-search-input> </div> <div class=row> <div class="col-md-2 leftpanel hidden-xs hidden-sm"> </div> <div class="col-md-7 content"> <article> <h1 class=title>Top 3 bugs I make in shell scripts</h1> <i>by Wojciech Adam Koszek</i> &nbsp;&nbsp;&sdot;&nbsp;&nbsp; <i>Oct 12, 2015</i> &nbsp;&nbsp;&sdot;&nbsp;&nbsp; <i>Menlo Park, CA</i> <br/> <br/> <b>Things to shy away from when working on shell scripting. </b> <br/> <hr class=noprint /> <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f9a67fb0188b069" async=async></script> <div class=addthis_sharing_toolbox></div> <hr class=noprint /> <div class=article_body> <p>Most people involved in software rarely talk about bugs. Perhaps it’s because a lot of software designers are striving for perfection, and aren’t willing to talk about the times when the machine conquered them. We all create software bugs, so let’s break the silence. Below are my top three bugs which occur while writing shell scripts.</p> <h3 id=order-of-redirection>Order of redirection</h3> <p>Let’s take an example script which generates “STDOUT” on standard output and “STDERR” on standard error.</p> <pre class="highlight shell"><code><span class="gp">bash-3.2$ </span>cat script.sh
<span class="nb">echo </span>STDERR &gt; /dev/stderr
<span class="nb">echo </span>STDOUT &gt; /dev/stdout
</code></pre> <p>I often do:</p> <pre class="highlight shell"><code><span class="gp">bash-3.2$ </span>./script.sh 2&gt;&amp;1 &gt; /dev/null
STDERR
</code></pre> <p>But you must do:</p> <pre class="highlight shell"><code><span class="gp">bash-3.2$ </span>./script.sh &gt; /dev/null 2&gt;&amp;1
</code></pre> <h3 id=different-usage-on-different-systems>Different usage on different systems</h3> <p>I frequently use <code>script</code>, since it’s the easiest way to get a trace of whatever is happening in your shell. You start ‘script’, run commands, hit “exit” and in the current directory the file “typescript” will contain all the output from all the commands that you’ve run saved. Trick: MacOSX and BSD-based systems:</p> <pre class="highlight shell"><code>script your_logfile.log <span class="nb">command</span>…
</code></pre> <p>are different than Linux:</p> <pre class="highlight shell"><code>script -c ‘your <span class="nb">command</span>’ file
</code></pre> <p>That’s the common problem, e.g.: I don’t like MacOSX not having <code>readlink -f</code> support. But oh well..</p> <h3 id=value-propagation-from-while-loops>Value propagation from <code>while</code> loops</h3> <p>Very often I forget that everything in shell programming is a command.</p> <p>Quiz: how do ‘[‘ and ‘]’ work?</p> <p>Looping is so essential in other languages, that sometimes, while scripting in shell, I forget that there are some things I can’t do. The other day I tried something like this:</p> <pre class="highlight shell"><code><span class="c">#!/bin/sh</span>
<span class="nv">X</span><span class="o">=</span>0
git status —porcelain | <span class="k">while </span><span class="nb">read </span>FILE; <span class="k">do</span>
	<span class="c"># ...</span>
	<span class="nv">X</span><span class="o">=</span>1
<span class="k">done</span>
</code></pre> <p>Before you continue reading, another quiz: why won’t it work?</p> <p>Compare the above with this:</p> <pre class="highlight shell"><code><span class="c">#!/bin/sh</span>
<span class="nv">cnt</span><span class="o">=</span>0
<span class="k">while</span> <span class="o">[</span> <span class="nv">$cnt</span> -lt 3 <span class="o">]</span>
<span class="k">do
	</span><span class="nb">echo</span> <span class="s2">"In the loop: </span><span class="sb">`</span>./getppid<span class="sb">`</span><span class="s2">"</span>
	<span class="nb">echo</span> <span class="nv">$cnt</span>
	<span class="nv">cnt</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$cnt</span> + 1<span class="sb">`</span>
<span class="k">done</span>
</code></pre> <p>Basically when your shell interprets this, it’s all contained in one single process. But once you use ‘|’, the pipe between two processes needs to be created, so whatever you have after the pipe sign will be running in a separate process, which the shell has forked for you. The solution to this is to restructure the loop so that everything happens in one single process:</p> <pre class="highlight shell"><code><span class="c">#!/bin/sh</span>
<span class="nv">X</span><span class="o">=</span>0
git status —porcelain &gt; _.p
<span class="k">while </span><span class="nb">read </span>FILE; <span class="k">do</span>
	<span class="c"># ...</span>
	<span class="nv">X</span><span class="o">=</span>1
<span class="k">done</span> &lt; _.p
</code></pre> <p>This is fairly inefficient, but it works on both Linux and FreeBSD, where <code>/bin/sh</code> is an actual BSD shell, not “BASH”.</p> <p><strong>What are your top three mistakes while writing shell scripts?</strong></p> </div> </article> <div class="row noprint"> <br> <div class="col-md-6 text-left"> </div> <div class="col-md-6 text-right"> </div> </div> <div class=noprint> <hr> <h3 id=mailing-list>Subscribe for updates</h3> <p> Once a month I send updates on the new content and hints for software engineers. <div id=mc_embed_signup class=row> <form action="//koszek.us3.list-manage.com/subscribe/post?u=0cfe70aa4cdf848b2adbd70c6&amp;id=bc454f0778" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=validate target=_blank novalidate> <div id=mc_embed_signup_scroll class=col-md-12> <input type=email value="" name=EMAIL class="required email" id=mce-EMAIL placeholder="Enter E-mail here"> <div id=mce-responses class=clear> <div class=response id=mce-error-response style="display:none"></div> <div class=response id=mce-success-response style="display:none"></div> </div> <div style="position: absolute; left: -5000px;"><input name=b_0cfe70aa4cdf848b2adbd70c6_bc454f0778 tabindex=-1 value=""></div> <div class=clear><input type=submit value=Subscribe name=subscribe id=mc-embedded-subscribe class=button width="100%"></div> </div> </form> </div> </p> <hr> <b>Liked it? Share it!</b> <script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f9a67fb0188b069" async=async></script> <div class=addthis_sharing_toolbox></div> <hr> <p><br/> <strong>About the author:</strong> I’m Wojciech Adam Koszek. I like software, business and design. Poland native. In Bay Area since 2010.   <a href="/about/">More about me…</a></p> <hr> <div id=disqus_thread></div> <script>

var disqus_config = function () {
this.page.url = document.location.href.split('?')[0].split('#')[0];
this.page.identifier = this.page.url;
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//koszek.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </div> <div class=col-md-1> </div> <div class="col-md-2 rightpanel noprint"> <br><h4>Mailing list</h4> <a href="#mailing-list">Subscribe</a> <br><h4>RSS feed</h4> <a href="http://www.koszek.com/feed.xml">RSS</a> <h4>Contact</h4> <a href="mailto:wojciech@koszek.com">E-mail</a><br> <a href="https://twitter.com/wkoszek/">Twitter</a><br> <a href="https://www.linkedin.com/in/wkoszek/">LinkedIn</a><br> <a href="https://github.com/wkoszek/">Github</a><br> <h4>Tags</h4> <span class=tag> <a href="/blog/tags/software-engineering">software engineering</a> </span> <br> <span class=tag> <a href="/blog/tags/tools">tools</a> </span> <br> <span class=tag> <a href="/blog/tags/entrepreneurship">entrepreneurship</a> </span> <br> <span class=tag> <a href="/blog/tags/productivity">productivity</a> </span> <br> </div> </div> <div class="row noprint"> <div class="col-md-12 footer"> <i>&copy;&nbsp;2012&dash;2017 Wojciech Adam Koszek (<a href="https://www.twitter.com/wkoszek/">@wkoszek</a>)</i> <br> Visits so far: <script>
var sc_project=10468040; 
var sc_invisible=0; 
var sc_security="b542d462"; 
var sc_text=2; 
var scJsHost = (("https:" == document.location.protocol) ?  "https://secure." : "http://www.");
document.write("<sc"+"ript type='text/javascript' src='" + scJsHost+ "statcounter.com/counter/counter.js'></"+"script>");
</script> <noscript> <div class=statcounter> <a title="free web stats" href="https://statcounter.com/free-web-stats/" target=_blank> <img class=statcounter src="https://c.statcounter.com/10468040/0/b542d462/0/" alt="free web stats"/></a> </div> </noscript> </div> </div> </div> <script>
        var active_page_elem = document.getElementById('active_page_name')
        var active_page_name = (active_page_elem != null ? active_page_elem.textContent : "blog");
        var active_page_link = document.getElementById(active_page_name);
        active_page_link.className = "ac";
    </script> </body> </html>