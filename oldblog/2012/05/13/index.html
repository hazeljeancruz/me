<!DOCTYPE html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta charset="utf-8" />
<link rel="stylesheet" href="/960/css/reset.css" />
<link rel="stylesheet" href="/960/css/text.css" />
<link rel="stylesheet" href="/960/css/960_24_col.css" />
<link rel="stylesheet" href="/960/css/demo.cssS" />
<link rel="stylesheet" href="/style.css" />
<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico">
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-8027537-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<title>
Wojciech A. Koszek,
Unfriendly IT, or how to get Perforce diffs e-mailed to you
</title>
</head>
<body>


<div class="container_24">
	<!-- SPACE -->
	<div class="grid_24">
		<br>
	</div>
	<div class="clear"></div>


	<!-- HEADER -->
	<div class="grid_4" id="menu">
		&nbsp;
	</div>
	<div class="grid_20" id="header">
		<p>
			Wojciech Adam Koszek &mdash; Homepage
		</p>
	</div>
	<div class="clear"></div>


	<!-- SPACE -->
	<div class="grid_24">
		<br>
	</div>
	<div class="clear"></div>


	<!-- MAIN:MENU -->
	<div class="grid_2" id="menu">
<a href="http://www.koszek.com"/>BLOG</a>
<br>
<br>
<a href="http://www.koszek.com/books.html"/>BOOKS</a>
<br>
<br>
<a href="http://www.koszek.com/software.html"/>SOFTWARE</a>
<br>
<br>
<a href="http://www.koszek.com/papers.html"/>PAPERS</a>
<br>
<br>
	</div>
	<div class="grid_2">
	<!-- SPACE -->
		&nbsp;
	</div>

	<!-- MAIN:CONTENT -->
	<div class="grid_17" id="content">
<h2>Unfriendly IT, or how to get Perforce diffs e-mailed to you</h2>

<p><strong>by Wojciech Koszek</strong></p>

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_button_google_plusone"></a>
<!-- <a class="addthis_counter addthis_bubble_style"></a> -->
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=xa-4f9b57ef259d6c68"></script>
<br>
<!-- AddThis Button END -->


<p>Work for a big corporation can be very depressing sometimes. This touches me
especially when I have to request something, and IT department doesn't
agree for providing me this functionality. Sometimes things are very simple,
sometimes are more complex.</p>

<p>Sometimes no time is the problem, sometimes "My request is not important
enough to dedicate time for it". Sometimes I don't know how to push my
company further. For now I've just set a "15 business days reminder". We'll
see.</p>

<p>In this particular case, I tried to provide myself a way to review Perforce
commits other person working with me was doing. Solution, which we all know to
be pretty darn good, is to have <code>diffs</code> e-mailed to you, just like we do on:</p>

<p><a href="http://lists.freebsd.org">FreeBSD mailing lists</a></p>

<p>But, as you already know, getting this functionality isn't always that easy
if you have The Big Brother. Most often than not, I end up crafting myself
yet-another-tiny-script, that helps me a lot. </p>

<p>Here it is:</p>

<pre><code>#!/bin/sh
# vim: set tw=1000:

#
# You must do p4 changes &gt; ~/.p4_diff/prev before starting
# to use this script.
#

p4=/home/wojciec/bin/p4

dir=/home/wojciec/.p4_diff/

mkdir -p $dir

curr=$dir/curr
prev=$dir/prev

$p4 changes &gt; $curr

diff $prev $curr 2&gt;&amp;1 &gt; /dev/null
if [ $? -eq 0 ]; then
    # no new commits.
    echo "P4DIFF: no commits";
    exit 0;
fi

#Fool-proof stuff
DIFF_NUM=`diff -u $prev $curr | wc -l | cut -d " " -f 1`
if [ $DIFF_NUM -gt 25 ]; then
    echo "P4DIFF: something is wrong with metadata: &gt; 25 commits in 5 mins?";
    exit;
fi

diff -u $prev $curr | grep '^+C' | while read DIFF_LINE; do
    CHANGE_NUM=`echo $DIFF_LINE | cut -d " " -f 2`
    SUBJECT="P4DIFF `echo $DIFF_LINE | sed 's/^+//' | cut -d " " -f 2,6-`"

    echo "DIFF_LINE      : $DIFF_LINE"
    echo "SUBJECT:       : $SUBJECT";
    echo "CHANGE_NUM     : $CHANGE_NUM";

    $p4 describe -du $CHANGE_NUM | mail -s "$SUBJECT" wojciec
done
cp $curr $prev
</code></pre>

<p>I purposefully didn't fix it, so that you understand what you're doing
(hint: read the comment). Cron job with this script will produce some junk
on the output and will get e-mailed to you. I prefer that  -- I have a
e-mail filter dumping these e-mails to a separate e-mail folders under CRON/
directory, so that I can inspect things going wrong. </p>

<p>PS: This post doesn't solve "How to keep your Perforce session opened", but
    I'm not brave enough to show it to you, so this is that part you have to
    figure out by yourself.</p>

<p>Script turned out to be pretty useful. I can see from Perforce what sort of
problems hardware group is solving!</p>
		<br><br><br>
		&copy; 2012-2014 Wojciech Adam Koszek &lt;wkoszek@FreeBSD.org&gt;
		<br>
<hr>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'koszek'; // required: replace example with your forum shortname
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<!-- <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a> -->

	</div>
	<!-- SPACE -->
	<div class="grid_1" id="sa">
		&nbsp;
	</div>

	<!-- ADDS -->
	<div class="grid_2" id="lr">

<iframe src="http://rcm.amazon.com/e/cm?lt1=_blank&bc1=FFFFFF&IS2=1&npa=1&bg1=FFFFFF&fc1=000000&lc1=FF0000&t=wojcadamkoszh-20&o=1&p=8&l=as4&m=amazon&f=ifr&ref=ss_til&asins=0596101856" style="width:120px;height:240px;" scrolling="no" marginwidth="0" marginheight="0" frameborder="0"></iframe>  

	</div>
	<div class="clear"></div>

</div>
</body>
</html

